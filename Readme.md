# Social Travel

Проектирование социальной сети для путешественников в рамках курса по System Design.

## Сбор требований

### Функциональные требования

Описание функциональности от бизнеса:

- публикация постов из путешествий с фотографиями, небольшим описанием и привязкой к конкретному месту путешествия;
- оценка и комментарии постов других путешественников;
- подписка на других путешественников, чтобы следить за их активностью;
- поиск популярных мест для путешествий и просмотр постов с этих мест;
- просмотр ленты других путешественников и ленты пользователя, основанной на подписках в обратном хронологическом порядке;

### Нефункциональные требования

- География пользователей: страны СНГ, не планируем работать в других регионах
- Общее количество пользователей в течение года: 10_000_000.
  Планируется дальнейший рост количества пользователей.
- Используемые платформы:
  - Мобильные устройства
  - Браузер
- "Очень надежная" система (SLO = 99.99%)
  -> 52м 36с недоступность в год
- Сезонность: присутствует, летом и зимой. (множитель х2)
- Места для путешествий: ограничены
- Лента постов: бесконечная, подгружаем по 10 постов
- Поиск популярных мест: раз в день делать ТОП-100 мест (ночью, когда нагрузка уменьшается)

Показатели:

Показатели | Среднее | Максимальное
-------|-----|-----
Пользователей в сутки (DAU) | - | 1_000_000
Постов в сутки у пользователя | 1 | 10
Фотографий в посте | 1 | 10
Размер фотографии в посте | 2Мб | 5Мб
Символов в описании | 100 | 500
Подписчиков | 500 | 1_000_000
Оценок поста в день | 10 | 100_000
Оценок поста всего | 100 | 1_000_000
Комментариев к посту в день | 5 | 1000
Комментариев к посту | 10 | 10_000
Мест для путешествий | - | 10_000
Запросов популярных мест в день 1 пользователем | 1 | 10
Запросов к ленте пользователя | 1 | 10
Постов на странице в ленте | - | 10

#### Ограничения

- Время хранения постов: навсегда
- Удаление неактивных пользователей: через год
- Максимальный объем фотографии: 5Мб

Время:

- Создание поста: 5 сек.
- Добавление оценки: 3 сек.
- Добавление комментария: 3 сек.
- Получение ленты постов: 1 сек.
- Получение комментариев поста: 2 сек.
- Получение фотографий поста: 3 сек.
- Получение оценки поста: 500 мс

#### Нагрузка

##### RPS

- Запросов на создание поста          = 1_000_000 * 1   / 86400 = 10
- Запросов на добавление фотографии   = 1_000_000 * 1   / 86400 = 10
- Запросов на добавление комментария  = 1_000_000 * 5   / 86400 = 50
- Запросов на оценку поста            = 1_000_000 * 10  / 86400 = 100
- Запросов на чтение поста            = 1_000_000 *(10 + 10)* 1  / 86400 = 200
- Запросов на чтение фотографии       = 1_000_000 *(10 + 10)* 1  / 86400 = 200
- Запросов на чтение комментариев     = 1_000_000 *(10 + 10)* 10 / 86400 = 2000
- Запросов на чтение оценок поста     = 1_000_000 *(10 + 10)* 1  / 86400 = 200

##### Схемы хранения данных

Пользователь:

- user_id 8b
- name 15b
- surname 20b
- lastname 15b
- description 100b

Total: 166b

Подписчики:

- id 8b
- user_id 8b
- subscriber_id 8b

Пост:

- post_id 8b
- user_id 8b
- place_id 8b
- description 100b
- edited_at 8b
- created_at 8b

Total: 140b

Оценка поста:

- user_id 8b
- post_id 8b
- reaction 1b (1-10)

Total: 17b

Рейтинг поста:

- post_id 8b
- total_score 8b
- count_users 8b

Total: 24b

Комментарий поста:

- comment_id 8b
- post_id 8b
- user_id 8b
- comment 100b
- edited_at 8b
- created_at 8b

Total: 140b

Загрузка фотографии:

- media_id 8b
- user_id 8b
- url 32b
- created_at 8b

Total: 56b + загрузка в хранилище

Хранилище фотографий:

- url 32b
- image 2Mb

Total: 2Mb

Фотография поста:

- image_id 8b
- post_id 8b
- url 30b

Total: 46b

Место:

- place_id 8b
- name 80b
- description 100b
- coordinate 16b
Total: 204b

##### Трафик

Write:

- Создание поста = 10 * (140 + 46 + 24) = 2.1 Kb/s
- Добавление фотографии = 10 * 2Mb= 2 Mb/s
- Добавление комментариев = 50 * 140 = 7 Kb/s
- Добавление оценки = 100 * (17 + 24) = 4.1 Kb/s

Read:

- Чтение поста = 200 * (140 + 24) = 3.2 Kb/s
- Чтение картинок поста = 200 * 2Mb = 400Mb/s
- Чтение комментариев = 2000 * 140 = 280 Kb/s
- Чтение оценок = 200 * 24 = 4.8 Kb/s

#### Диски

1. Посты:

- Capacity = `2.1 Kb/s * 86400 * 365` = 67 Mb
- Disks for capacity = `67Mb / 128Gb` = 1 disk
- Disks for throughput = `2.1 + 3.2 Kb/s / 500 Mb/s` = 1 disk
- Disks for iops (SSD SATA) = `(200 + 10) / 1000` = 1 disk
- Disks for iops (HDD) = `(200 + 10) / 100` = 3 disks
- Disks = 1 SSD (SATA) disk or 3 HDD disks by 128 Gb = 1 SSD

2. Картинки:

- Capacity = `2 Mb/s * 86400 * 365 = 63 Tb`
- Disks for capacity = `63 Tb / 8 Tb` ~= 9 disks
- Disks for throughput (SSD SATA) = `402 Mb/s / 500 Mb/s` = 1 disk
- Disks for throughput (HDD) = `402 Mb/s / 100 Mb/s` = 5 disks
- Disks for iops (SSD SATA) = `(200 + 10) / 1000` = 1 disk
- Disks for iops (HDD) = `(200 + 10) / 100` = 3 disks
- Disks = 9 HDD disks by 8 Tb

3. Комментарии:

- Capacity = `7 Kb/s * 86400 * 365 = 221 Gb`
- Disks for capacity = `221 Gb / 256 Gb` = 1 disk
- Disks for throughput = `287 Kb/s / 100 Mb/s` = 1 disk
- Disks for iops (SSD SATA) = `(2000 + 50) / 1000` = 3 disk
- Disks for iops (HDD) = `(2000 + 50) / 100` = 21 disks
- Disks = 3 SSD (SATA) disks or 21 HDD disks by 256 Gb = 3 SSD

4. Оценки:

- Capacity = `4 Kb/s * 86400 * 365 = 127 Gb`
- Disks for capacity = `127 Gb / 128 Gb` = 2 disk
- Disks for throughput = `(4.8 + 4.1) Kb/s / 100 Mb/s` = 1 disk
- Disks for iops (SSD SATA) = `(100 + 200) / 1000` = 1 disk
- Disks for iops (HDD) = `(100 + 200) / 100` = 4 disks
- Disks = 1 SSD (SATA) disk by 256 Gb or 4 HDD disks by 128 Gb = 1 SSD

#### Распределенное хранение

Будем использовать **PostgreSQL**

##### Шардирование

Используем **Consistent** шардирование, так легко и просто можно решардироваться,
сразу выделим `2*2*3*5*7 = 420` виртуальных шардов.

1. Посты шардируем по user_id
2. Картинки шардируем по post_id
3. Комментарии шардируем по post_id
4. Оценки шардируем по

##### Реплицирование

- **Async** репликация т.к. данные могут отставать и это не критично.
- **Master-Slave** - репликации
- **Replication Factor** = 3

##### Подсчёт ресурсов

1. Посты
  Hosts = 1 disks / 1 disk per host * 3 Replication Factor (RF) = 3 hosts by 1 disks
2. Картинки
  Hosts = 9 disks / 2 disks per host * 3 RF = 15 hosts by 2 disks
3. Комментарии
  Т.к. количество дисков обусловлено высокой Read нагрузкой, то её можно снизить
  за счёт репликации.
  Hosts = 1 disks / 1 disks per host * 3 RF  = 3 hosts by 1 disks
4. Оценки
  Hosts = 1 disks / 1 disks per host * 3 RF = 3 hosts by 1 disks
